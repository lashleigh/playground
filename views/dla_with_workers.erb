<div style="clear:both;">
<button onclick="playSim()">Start</button>
<button onclick="pause()">Pause</button></br>
<output id="result"></output>
<div id="time"></div>
</div>

<script>
  var CANVAS_SIZE = 1500;
  var STEP = 3;
  var MAX = Math.floor(CANVAS_SIZE/STEP);
  var HALF_MAX = Math.floor(MAX/2);
  var TIME = 765;
  var COLOR;
  var edge = 25; //Math.floor(HALF_MAX/2);
  var idle = true;
  var start_time;
  var finish_time;

  // canvas element and 2D context
  var canvas = document.createElement('canvas');
  canvas.width = CANVAS_SIZE;
  canvas.height = CANVAS_SIZE;
  document.body.appendChild(canvas);
  var context = canvas.getContext('2d');

  context.fillStyle="rgb(255,255,255)";
  context.fillRect(0,0, CANVAS_SIZE, CANVAS_SIZE);


  var grid = [];
  reset_grid()
  function stop() {
    worker.terminate()
  }
  function randomMatch(iters) {
    idle = false;
    document.getElementById('result').textContent = "computing";
    worker.postMessage({'cmd': 'grid', 'grid':grid, 'dim':MAX, 'edge':edge, 'num':iters});
  }

  var worker = new Worker('js/worker.js');

  worker.addEventListener('message', function(e) {
    var res = e.data;
    edge = res.edge;
    console.log(edge, Math.sqrt(res.max_dist));
    for(var i = 0; i < res.coords.length; i++) {
      if(i%10===0) { TIME += 2; COLOR = makeColor(TIME);}
      var x = res.coords[i].x;
      var y = res.coords[i].y;
      grid[x][y] += 1;
      draw_point(x, y); 
    }
    document.getElementById('result').textContent = res.iter+" and coords length: "+res.coords.length;
    if((res.iter != 0) && (edge < HALF_MAX)) {
      idle = true;
    } else {
      finish_time = new Date();
      document.getElementById('time').textContent = "Finished in: "+(finish_time-start_time)/1000.0+" sec";
    }
  }, false);

  function draw_point(x,y,exception) {
    if(grid[x][y]==1 || exception) {
    var c = context;
    c.fillStyle = COLOR || makeColor(TIME) //: "#555"; //COLORS[COLOR_INDEX]; //this.color(); // "rgba(5, 5, 5, "+this.level/10.0+")"
    c.beginPath();
    c.rect(x*STEP, y*STEP, STEP, STEP)
    c.closePath();
    c.fill();
    }
  }
  function clear_point(x,y) {
    var c = context;
    c.fillStyle = '#fff'; 
    c.beginPath();
    c.rect(x*STEP, y*STEP, STEP, STEP)
    c.closePath();
    c.fill();
  }
  var intervalID;
function playSim(iters) {
  start_time = new Date();
  idle = true;
  edge = 25;
  create_nuclei();
  intervalID = setInterval(function() {
    if(idle) {
      randomMatch(iters || 75);
    }
  }, 1000/30);
}
function pause() {
  clearInterval(intervalID)
}
  
// Do Awesome Things With Colors!
function makeColor(index) {
  function color(i) {
    // Wrap around using modulus 
    i = Math.floor(i) % 1530;

    // Calculate the value
    var v;
    if(i < 255)       v = i;
    else if(i < 765)  v = 255;
    else if(i < 1020) v = 255 - (i - 765);
    else              v = 0;

    // Make it a zero-padded value
    v = v.toString(16);
    if(v.length == 1) return "0" + v;
    else              return v;
  }
  function red(i)   { return color(i + 510); }
  function green(i) { return color(i);        }
  function blue(i)  { return color(i + 1020);  }

  return "#" + red(index) + green(index) + blue(index);
}
function clear() {
  edge = 25;
  reset_grid();
  create_nuclei();
  context.fillStyle="rgb(255,255,255)";
  context.fillRect(0,0, CANVAS_SIZE, CANVAS_SIZE);
}
function reset_grid() {
  for(var i=0; i < MAX; i++) {
    grid[i] = [];
    for(var j=0; j < MAX; j++) {
      grid[i][j] = 0;
    }  
  }
}
function create_nuclei() {
  for(var i=HALF_MAX-2; i<HALF_MAX+2; i++) {
    for(var j=HALF_MAX-2; j<HALF_MAX+2; j++) {
      grid[i][j] = 1;
      draw_point(i, j);
    }
  }
}
function random_from_polar(radius) {
  var angle = Math.random()*2*Math.PI;
  radius = Math.min(radius, MAX/2);
  var x = Math.floor(radius*Math.cos(angle))+MAX/2
  var y = Math.floor(radius*Math.sin(angle))+MAX/2
  return {'x':x, 'y':y};
}
function draw_circle(radius) {
  for(var i=0; i<radius*8; i++) {c = random_from_polar(radius, MAX); draw_point(c.x, c.y, true)}
}
function clear_circle(radius) {
  for(var i=0; i<radius*8; i++) {c = random_from_polar(radius, MAX); clear_point(c.x, c.y)}
}
</script>
